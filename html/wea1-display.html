<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather App - Current and 24-hour Forecast</title>
  <!-- <link rel="stylesheet" href="../css/style5.css"> -->
  <link rel="stylesheet" href="../css/wea_1.css">
  <link rel="stylesheet" href="../css/wea1-color.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

  <div class="default-set"></div>

  <div class="weather-container" id="iii">
    <div class="result-container" id="weather-result">
      <p>Enter city name in app setting</p>
    </div>
    <!-- Weather results will be displayed here -->
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    let currentUnit = 'metric';
    let airQualityChart = null;




    ipcRenderer.on('weather-data', (event, weatherData) => {
      console.log("weather-data event triggered");
      if (weatherData) {
        if (weatherData.error) {
          console.error(weatherData.error);
          document.getElementById('weather-result').innerHTML = `<p>Error: ${weatherData.error}</p>`;
        } else {
          console.log("Received weather data", weatherData);
          displayWeather(weatherData);
        }
      } else {
        console.log("No weather data received");
      }
    });

    function celsiusToFahrenheit(celsius) {
      return (celsius * 9 / 5) + 32;
    }

    function fahrenheitToCelsius(fahrenheit) {
      return (fahrenheit - 32) * 5 / 9;
    }



    // <h2>Current Weather in ${weatherData.weather.name}</h2>
    //     <p>Temperature: ${weatherData.weather.main.temp} ${unitSymbol}</p>
    //     <p>Weather: ${weatherData.weather.weather[0].description}</p>
    //     <p>Air Quality Index: ${weatherData.air.list[0].main.aqi}</p>
    //     <h2>Next 24-hour Forecast</h2>`;

    function displayWeather(weatherData) {
      // const unitSymbol = weatherData.unit === 'metric' ? 'c' : 'f';

      const temperatureC = Math.round(weatherData.weather.main.temp);
      const temperatureF = Math.round(fahrenheitToCelsius(temperatureC));
      const temperatureFonC = Math.round(celsiusToFahrenheit(temperatureC));
      const temperatureConF = Math.round(weatherData.weather.main.temp);


      const description = weatherData.weather.weather[0].description.toLowerCase();
      // const temperature = Math.round(weatherData.weather.main.temp);


      let weatherImage = '';
      if (description.includes('clear')) {
        weatherImage = '../src/weather/clear.png';
      } else if (description.includes('few')) {
        weatherImage = '../src/weather/few.png';
      } else if (description.includes('scattered')) {
        weatherImage = '../src/weather/scattered.png';
      } else if (description.includes('broken')) {
        weatherImage = '../src/weather/broken.png';
      } else if (description.includes('overcast')) {
        weatherImage = '../src/weather/broken.png';
      } else if (description.includes('shower')) {
        weatherImage = '../src/weather/shower.png';
      } else if (description.includes('thunderstorm')) {
        weatherImage = '../src/weather/thunder.png';
      } else if (description.includes('drizzle')) {
        weatherImage = '../src/weather/shower.png';
      } else if (description.includes('rain')) {
        weatherImage = '../src/weather/rain.png';
      } else if (description.includes('snow')) {
        weatherImage = '../src/weather/snow.png';
      } else if (description.includes('sleet')) {
        weatherImage = '../src/weather/snow.png';
      } else {
        weatherImage = '../src/weather/mist.png';
      }


      const mainTemperature = currentUnit === 'metric' ? `${temperatureC}` : `${temperatureFonC}`;
      const mainUnitSymbol = weatherData.unit === 'metric' ? 'C' : 'F';
      const secondaryTemperature = weatherData.unit === 'metric' ? `${temperatureFonC}` : `${temperatureF}`;
      const secondaryUnitSymbol = weatherData.unit === 'metric' ? 'F' : 'C';


      // console.log('TemperatureC', temperatureC);
      // console.log('TemperatureF', temperatureF);
      // console.log('TemperatureConF:', temperatureConF);
      // console.log('TemperatureFonC:', temperatureFonC);
      // console.log('lalalla', weatherData.weather.main.temp)



      let forecastHtml = `
          <div class="current-weather">
            <img src="../images/${weatherImage}" alt="${description}" class="weather-image">
            <div class="inner-contents">
              <p class="temperature">${mainTemperature}</p>
              <p class="circle">°</p>
              <span class="unit-symbol">${mainUnitSymbol}</span>
              <p class="wea-des">${weatherData.weather.weather[0].description}</p>
              <p class="temperature2">${secondaryTemperature}</p>
              <p class="circle2">°</p>
              <span class="unit-symbol2">${secondaryUnitSymbol}</span>
              <div class="back-bar"></div>
              <canvas id="airQualityChart"></canvas>
            </div>
          </div>`;


      // weatherData.forecast.forEach(forecast => {
      //   const date = new Date(forecast.dt * 1000);
      //   forecastHtml += `
      //     <div>
      //       <p><strong>${date.toLocaleString()}</strong></p>
      //       <p>Temperature: ${forecast.main.temp} ${unitSymbol}</p>
      //       <p>Weather: ${forecast.weather[0].description}</p>
      //     </div>`;
      // });

      document.getElementById('weather-result').innerHTML = forecastHtml;
      console.log("Weather data displayed");


      displayAirQualityChart(weatherData.air.list[0].main.aqi);
    }



    function barColors(colorSet) {
      

    }



    function displayAirQualityChart(aqi) {
      const ctx = document.getElementById('airQualityChart').getContext('2d');

      if (airQualityChart) {
        airQualityChart.destroy(); // 기존 차트를 제거합니다.
      }

      const inverseAqi = 100 - (aqi - 1) * 20;

      const barco = barColors

      // const colorTheme = localStorage.getItem('wea1ColorSet', colorTheme);

      // const colorSet = button.getAttribute('data-color-set');
      // localStorage.setItem('wea1ColorSet', colorSet);
      // ipcRenderer.on('change-wea1-color', colorSet);


      // Remove existing color theme classes
      // chartContainer.classList.remove('grey', 'pink', 'blue', 'green', 'red');

      // Add the selected color theme class
      // if (colorTheme) {
      //   chartContainer.classList.add(colorTheme);
      // }

      // Retrieve the background color from the applied CSS class



      airQualityChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Air Quality Index'],
          datasets: [{
            label: 'AQI',
            data: [inverseAqi],
            backgroundColor: barco




            // aqi === 1 ? 'green' :
            //   aqi === 2 ? 'yellow' :
            //     aqi === 3 ? 'orange' :
            //       aqi === 4 ? 'red' : 'purple'
          }]
        },
        options: {
          indexAxis: 'y',
          maintainAspectRatio: false,
          responsive: true,
          barPercentage: 1.00,
          categoryPercentage: 1.00,
          scales: {
            x: {
              beginAtZero: true,
              max: 100,
              offset: false, // 축의 오프셋 제거
              ticks: {
                display: false // x축 눈금 제거
              },
              grid: {
                display: false // x축 그리드 제거
              }
            },
            y: {
              ticks: {
                display: false // y축 눈금 제거
              },
              grid: {
                display: false // y축 그리드 제거
              }
            }
          },
          layout: {
            padding: -10,
            border: 0,
            magin: 0
          },
          plugins: {
            legend: {
              display: false // 범례 제거
            },
            tooltip: {
              enabled: false // 툴팁 제거
            }
          }
        }
      });
    }

    // function toggleUnit() {
    //   currentUnit = currentUnit === 'metric' ? 'imperial' : 'metric';
    //   const toggleButton = document.getElementById('toggle-unit');
    //   toggleButton.innerText = currentUnit === 'metric' ? 'Toggle to °F' : 'Toggle to °C';
    //   ipcRenderer.send('request-weather-data');
    // }

    document.addEventListener('DOMContentLoaded', () => {
      console.log("wea1-display.html loaded and waiting for weather data");
      ipcRenderer.send('request-weather-data');

      ipcRenderer.on('toggle-unit', (event, newUnit) => {
        currentUnit = newUnit;
        updateUnitSymbols();
      });
    });

    function resizeWea({ newWidth, newHeight }) {
      const calElement = document.getElementById('iii');
      if (calElement) {
        const scaleFactor = newWidth / 405;
        document.documentElement.style.fontSize = `${scaleFactor * 16}px`; // Adjust root font size
        calElement.style.width = `${newWidth}px`;
        calElement.style.height = `${newHeight}px`;

      }
    }


    ipcRenderer.on('resize-wea1', (event, { newWidth, newHeight }) => {
      resizeWea({ newWidth, newHeight });
    });

    ipcRenderer.on('change-wea1-color', (event, colorSet) => {
      document.body.className = colorSet;
    });





  </script>
</body>

</html>